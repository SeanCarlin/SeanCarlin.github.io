<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Barriers - A HTML5 Canvas Game</title>
  <meta name="description" content="Avoid the barriers at all costs! Built using HTML5 Canvas and JavaScript.">
  <meta name="viewport" content="user-scalable=no">
<style>

	body { margin: 0; }
	canvas { display: block; }

</style>
</head>
<body id="body">
  <canvas id="c"></canvas>
	<script>
	// Initialising variables
	var ctx = c.getContext("2d"),
		W = innerWidth,
		H = innerHeight,
		gameHeight = 543,
		borderHeight = (H - gameHeight)/2,
		barrierHeight = 160;

	// Setting canvas dimensions
	c.width = W;
	c.height = H;

	// Some more variables
	var player,
		active,
		barriers,
		n,
		score,
		highScore = 0,
		playerSpeed = 3,
		barrierSpeed = 4,
		frames = 0,
		tries = 0,
		running,
		color = "#00FF92";

	// Restores all variables
	function init(){
		ctx.fillStyle = color;
		ctx.font = "50px Arial";
		player = {
			size: 20,
			x: 200,
			y: c.height / 2 - 10
		};
		active = false;
		barriers = [];
		n = 0;
		score = 0;
		running = true;
	}

	// Draws to the canvas
	function draw(){
		if (running){
			var i, barrier;

			ctx.clearRect(0,0,c.width,c.height);
		  	ctx.fillRect(player.x, player.y, player.size, player.size);
			ctx.fillRect(0,0,c.width,(H-gameHeight)/2);
			ctx.fillRect(0,c.height-(H-gameHeight)/2,c.width,(H-gameHeight)/2);
			ctx.fillText(score, c.width - 70, borderHeight + 50);

			for (i = 0; i < n; i++){
				barrier = barriers[i];
				ctx.fillRect(barrier.x, barrier.y, 20, barrierHeight);
			}
		} else
			return;
	}

	// Updates coordinates, determines score and detects collisions
	function update(){
		var i, barrier;

		if (active)
			player.y -= playerSpeed;

		else
			player.y += playerSpeed;
		
		if (player.y + 20> c.height - borderHeight || player.y < borderHeight){
			barriers.splice(0, barriers.length);
			highScore = score > highScore ? score : highScore;
			tries++;
			if (tries === 3){
				tries = 0;
				running = false;
				gameOver();
				return;
			} else {
				return init();
			}
		}
		
		for (i = 0; i < n; i++){


			barrier = barriers[i];
			barrier.x-=7 ;
			if (barrier.x < -20){
				barriers.splice(i, i+1);
				n--;
			}
			
			if (player.x + 20 > barrier.x && player.x < barrier.x + 20 && player.y + 20 > barrier.y && player.y < barrier.y + barrierHeight){
				barriers.splice(0, barriers.length);
				highScore = score > highScore ? score : highScore;
				tries++;
				if (tries === 3){
					tries = 0;
					running = false;
					gameOver();
					return;
				} else {
					return init();
				}
			}
			
			if (player.x > barrier.x + 20 && player.x < barrier.x + 27)
				score++;

			if (barrier.y + barrierHeight >= H - borderHeight)
				barrier.vy = -Math.abs(barrier.vy);

			if (barrier.y <= borderHeight)
				barrier.vy = Math.abs(barrier.vy);
			
			barrier.y += barrier.vy;


		}
	}

	// Creates a barrier
	function createBarriers(){
		n++;
		barriers.push({
			x: c.width,
			y: borderHeight + Math.floor(Math.random() * (gameHeight - barrierHeight)),
			vy: Math.random() > 0.5 ? barrierSpeed : -Math.abs(barrierSpeed)
		});
	}

	// Displays game over message after 3 tries
	function gameOver(){
		ctx.fillRect(0,0,c.width,c.height);
		ctx.fillStyle = "white";
		ctx.fillText("Game Over.", 150, H / 2 - 15);
		ctx.font = "16px Arial";
		ctx.fillText("Your High Score was: " + highScore, 160, H / 2 + 30);
		highScore = 0;
		setTimeout(function(){ ctx.clearRect(0,0,c.width,c.height); init(); main(); return; }, 3000);
	}

	// The main program
	function main(){
		if (running){
			frames++;
			if (frames === 60) { frames = 0; createBarriers(); }
			update();
			draw();
			requestAnimationFrame(main);
		} else {
			return;
		}
	}

	// Event Listeners
	addEventListener("keydown", function(){ active = true; });
	addEventListener("keyup", function(){ active = false; });

	addEventListener("mousedown", function(){ active = true; });
	addEventListener("mouseup", function(){ active = false; });

	addEventListener("touchstart", function(){ active = true; });
	addEventListener("touchend", function(){ active = false; });

	// Houston, we have lift-off.
	init(); 
	main();

</script>
</body>
</html>